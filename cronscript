#!/bin/bash
set -e

PR=$1
if [ -n "${PR}" ] ; then
    MESON_COMMIT="pull/${PR}/head"
fi

srcdir=`dirname "$0"`
git -C ${srcdir} pull >/dev/null

# update the docker container, if the Dockerfile has changed
if ! cmp -s ${srcdir}/Dockerfile ${srcdir}/Dockerfile.prev ; then
  cp ${srcdir}/Dockerfile ${srcdir}/Dockerfile.prev
  docker rmi mesoncorpusci jturney/mesoncorpusci || true
  docker build . -t mesoncorpusci -f ${srcdir}/Dockerfile
  docker tag mesoncorpusci jturney/mesoncorpusci
  echo $DOCKERHUB_PASSWORD | docker login --username jturney --password-stdin || true
  docker push jturney/mesoncorpusci
fi

# update the .travis.yml
DATE=`date -u +%Y%m%d`
git checkout ${PR:-master} || git checkout -b ${PR:-master}
${srcdir}/update ${srcdir}/config.yaml .travis.yml ${MESON_COMMIT}

if ! git diff --quiet 2>/dev/null ; then
  git add .travis.yml
  git commit -m "Update ${DATE} ${PR}" -m "Automatically generated by meson-corpus-test-update"
  git push origin ${PR:-master}
fi
