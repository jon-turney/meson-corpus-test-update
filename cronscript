#!/bin/bash
set -e

srcdir=`dirname "$0"`
git -C ${srcdir} pull >/dev/null
${srcdir}/update.py ${srcdir}/config.yaml .travis.yml

# update the docker container, if the Dockerfile has changed
if ! cmp -s ${srcdir}/Dockerfile ${srcdir}/Dockerfile.prev ; then
  cp ${srcdir}/Dockerfile ${srcdir}/Dockerfile.prev
  docker rmi mesoncorpusci jturney/mesoncorpusci || true
  docker build . -t mesoncorpusci -f ${srcdir}/Dockerfile
  docker tag mesoncorpusci jturney/mesoncorpusci
  echo $DOCKERHUB_PASSWORD | docker login --username jturney --password-stdin || true
  docker push jturney/mesoncorpusci
fi

# update the .travis.yml
if ! git diff --quiet 2>/dev/null ; then
  DATE=`date -u +%Y%m%d`
  git add .travis.yml
  git commit -m "Update ${DATE}" -m "Automatically generated by meson-corpus-test-update"
  git push origin master
fi
