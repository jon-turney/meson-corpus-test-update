#!/bin/bash
set -e

srcdir=`dirname "$0"`
git -C ${srcdir} pull
${srcdir}/update.py .travis.yml Dockerfile.new

# update the docker container, if the Dockerfile has changed
if ! cmp -s Dockerfile Dockerfile.new ; then
  mv Dockerfile.new Dockerfile
  docker rmi mesoncorpusci jturney/mesoncorpusci || true
  docker build . -t mesoncorpusci
  docker tag mesoncorpusci jturney/mesoncorpusci
  echo $DOCKERHUB_PASSWORD | docker login --username jturney --password-stdin || true
  docker push jturney/mesoncorpusci
fi

# update the .travis.yml
DATE=`date -u +%Y%m%d`
git add .travis.yml
git commit -m "Update ${DATE}" -m "Automatically generated by meson-corpus-test-update"
git push origin master
