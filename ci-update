#!/bin/bash
set -e

# update .yml files and commit, if changed

PR=$1
if [ -n "${PR}" ] ; then
    MESON_COMMIT="pull/${PR}/head"
fi

git checkout ${PR:-master} >/dev/null 2>&1 || git checkout -b ${PR:-master}

srcdir=`dirname "$0"`
${srcdir}/update ${srcdir}/config.yaml .travis.yml ${MESON_COMMIT}
${srcdir}/workflow-update ${srcdir}/config.yaml .github/workflows/corpus.yml ${MESON_COMMIT}

DATE=`date -u +%Y%m%d`
if ! git diff --quiet 2>/dev/null ; then
  git add .travis.yml .github/workflows/corpus.yml
  git commit -m "Update ${DATE} ${PR}" -m "Automatically generated by meson-corpus-test-update " -m "(using $(git -C ${srcdir} describe --always --dirty) on $(hostname))"
  git push origin ${PR:-master}
fi
