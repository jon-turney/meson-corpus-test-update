language: python
python: 3.6

cache:
  apt: true

services:
  - docker

install:
  - docker pull jturney/mesoncorpusci

before_script:
  - touch script
  - echo "apt-get -y update &&" >>script
  - if test -n "${BUILDDEP}" ; then echo "apt-get -y build-dep ${BUILDDEP} &&" >>script ; fi
  - if test -n "${ALSOINSTALL}" ; then echo "apt-get -y install ${ALSOINSTALL} &&" >>script ; fi
  - echo "retry pip3 install git+https://github.com/mesonbuild/meson.git &&" >>script
  - if test -n "${COMMIT}" ; then echo "retry 'git clone ${REPO} ${NAME} && git -C ${NAME} checkout ${COMMIT}' &&" >>script ; fi
  - if test -z "${COMMIT}" ; then echo "retry 'git clone --depth=10 --branch ${BRANCH:-master} ${REPO} ${NAME}' &&" >>script ; fi
  - echo "cd ${NAME} && " >>script
  - if test -n "${HACKS}" ; then echo "${HACKS} &&" >>script ; fi
  - echo "meson _build ${SOURCEDIR}" >>script

script:
  - cat script
  - docker run jturney/mesoncorpusci /bin/sh -c "$(cat script)"
