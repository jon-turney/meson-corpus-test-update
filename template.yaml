language: python
python: 3.6

cache:
  apt: true

services:
  - docker

install:
  - docker pull jturney/mesoncorpusci

before_script:
  - touch script
  - echo "chronic apt-get -y update &&" >>script
  - if test -n "${BUILDDEP}" ; then echo "chronic apt-get -y build-dep ${BUILDDEP} &&" >>script ; fi
  - if test -n "${ALSOINSTALL}" ; then echo "chronic apt-get -y install ${ALSOINSTALL} &&" >>script ; fi
  - if test -z "${MESON_COMMIT}" ; then echo "retry -- pip3 install git+https://github.com/mesonbuild/meson.git &&" >>script ; fi
  - if test -n "${MESON_COMMIT}" ; then echo "retry -- git clone https://github.com/mesonbuild/meson.git && retry -- git -C meson fetch origin ${MESON_COMMIT} && git -C meson checkout FETCH_HEAD && pip3 install ./meson &&" >>script ; fi
  - if test -n "${COMMIT}" ; then echo "retry -- git clone ${REPO} ${NAME} && git -C ${NAME} checkout ${COMMIT} &&" >>script ; fi
  - if test -z "${COMMIT}" ; then echo "retry -- git clone --depth=1 ${BRANCH} ${REPO} ${NAME} &&" >>script ; fi
  - echo "cd ${NAME} && git rev-parse HEAD &&" >>script
  - if test -n "${HACKS}" ; then echo "${HACKS} &&" >>script ; fi
  - echo "meson _build ${SOURCEDIR} ${CONFIG} &&" >>script
  - if test -n "${BUILD}" ; then echo "DESTDIR=/install ninja -C _build ${BUILD}" >>script ; fi
  - if test -z "${BUILD}" ; then echo "true" >>script ; fi

script:
  - cat script
  - docker run --security-opt seccomp:unconfined jturney/mesoncorpusci /bin/sh -c "$(cat script)"
